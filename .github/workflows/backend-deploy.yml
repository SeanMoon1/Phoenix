name: Backend Deploy to EC2

on:
  push:
    branches: ["main"]
    paths:
      - "Backend/**" # Backend í´ë” ë³€ê²½ ì‹œì—ë§Œ ì‹¤í–‰
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥
  workflow_call: # ìž¬ì‚¬ìš© ê°€ëŠ¥í•œ ì›Œí¬í”Œë¡œìš°ë¡œ í˜¸ì¶œ ê°€ëŠ¥

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Deploy to EC2 via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.BACK_HOST }}
          username: ${{ secrets.BACK_USER }}
          key: ${{ secrets.BACK_SSH_KEY }}
          port: 22
          envs: |
            NODE_ENV=production
            PORT=3000
            CORS_ORIGIN=${{ secrets.CORS_ORIGIN }}
            API_URL=${{ secrets.API_URL }}
            FRONTEND_URL=${{ secrets.FRONTEND_URL }}
            DB_HOST=${{ secrets.DB_HOST }}
            DB_USERNAME=${{ secrets.DB_USERNAME }}
            DB_PASSWORD=${{ secrets.DB_PASSWORD }}
            DB_DATABASE=${{ secrets.DB_DATABASE }}
            JWT_SECRET=${{ secrets.JWT_SECRET }}
            GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }}
            GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET }}
            NAVER_CLIENT_ID=${{ secrets.NAVER_CLIENT_ID }}
            NAVER_CLIENT_SECRET=${{ secrets.NAVER_CLIENT_SECRET }}
            KAKAO_CLIENT_ID=${{ secrets.KAKAO_CLIENT_ID }}
            KAKAO_CLIENT_SECRET=${{ secrets.KAKAO_CLIENT_SECRET }}
            AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }}
            AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }}
            AWS_REGION=${{ secrets.AWS_REGION }}
          script: |
            # ì• í”Œë¦¬ì¼€ì´ì…˜ ë””ë ‰í† ë¦¬ë¡œ ì´ë™
            cd /home/ubuntu/Phoenix

            # ê¸°ì¡´ í”„ë¡œì„¸ìŠ¤ ì¤‘ì§€
            pm2 stop phoenix-backend || true

            # ìµœì‹  ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
            git fetch origin
            git reset --hard origin/main

            # Backend ë””ë ‰í† ë¦¬ë¡œ ì´ë™
            cd Backend

            # .env íŒŒì¼ ìƒì„± (í™˜ê²½ë³€ìˆ˜ ì£¼ìž…)
            cat > .env << EOF
            NODE_ENV=production
            PORT=3000
            CORS_ORIGIN=$CORS_ORIGIN
            API_URL=$API_URL
            FRONTEND_URL=$FRONTEND_URL
            DB_HOST=$DB_HOST
            DB_PORT=3306
            DB_USERNAME=$DB_USERNAME
            DB_PASSWORD=$DB_PASSWORD
            DB_DATABASE=$DB_DATABASE
            JWT_SECRET=$JWT_SECRET
            JWT_EXPIRES_IN=7d
            GOOGLE_CLIENT_ID=$GOOGLE_CLIENT_ID
            GOOGLE_CLIENT_SECRET=$GOOGLE_CLIENT_SECRET
            GOOGLE_CALLBACK_URL=$API_URL/auth/google/callback
            NAVER_CLIENT_ID=$NAVER_CLIENT_ID
            NAVER_CLIENT_SECRET=$NAVER_CLIENT_SECRET
            NAVER_CALLBACK_URL=$API_URL/auth/naver/callback
            KAKAO_CLIENT_ID=$KAKAO_CLIENT_ID
            KAKAO_CLIENT_SECRET=$KAKAO_CLIENT_SECRET
            KAKAO_CALLBACK_URL=$API_URL/auth/kakao/callback
            AWS_ACCESS_KEY_ID=$AWS_ACCESS_KEY_ID
            AWS_SECRET_ACCESS_KEY=$AWS_SECRET_ACCESS_KEY
            AWS_REGION=$AWS_REGION
            LOG_LEVEL=info
            EOF

            # Rollup ì˜ì¡´ì„± ë¬¸ì œ í•´ê²°ì„ ìœ„í•œ ì •ë¦¬ í›„ ì„¤ì¹˜
            rm -rf node_modules package-lock.json
            npm install --only=production

            # TypeScript ë¹Œë“œ
            npm run build

            # ë°ì´í„°ë² ì´ìŠ¤ ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰ (í•„ìš”í•œ ê²½ìš°)
            npm run migration:run || true

            # PM2ë¡œ ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œìž‘/ìž¬ì‹œìž‘
            pm2 start ecosystem.config.js || pm2 restart phoenix-backend

            # PM2 í”„ë¡œì„¸ìŠ¤ ì €ìž¥
            pm2 save

            # í—¬ìŠ¤ì²´í¬
            sleep 10
            curl -f http://localhost:3000/health || exit 1

            echo "âœ… Backend deployment completed successfully!"

      - name: Deployment Status Check
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.BACK_HOST }}
          username: ${{ secrets.BACK_USER }}
          key: ${{ secrets.BACK_SSH_KEY }}
          script: |
            echo "ðŸ“Š PM2 Status:"
            pm2 status
            echo "ðŸ” Application Logs (last 20 lines):"
            pm2 logs phoenix-backend --lines 20 --nostream
