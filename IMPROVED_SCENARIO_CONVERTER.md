# üîÑ Í∞úÏÑ†Îêú ÏãúÎÇòÎ¶¨Ïò§ Î≥ÄÌôò ÏãúÏä§ÌÖú

## üìã ÌòÑÏû¨ Î¨∏Ï†úÏ†ê ÏöîÏïΩ

### 1. Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ Ïä§ÌÇ§Îßà Î∂àÏùºÏπò

- `difficulty` Ïª¨ÎüºÏù¥ DBÏóê ÏóÜÏùå
- `approval_status` Ïª¨ÎüºÏù¥ DBÏóê ÏóÜÏùå
- `scenario_scene` ÌÖåÏù¥Î∏îÏù¥ ÏóÜÏñ¥ Ïî¨ Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû• Î∂àÍ∞Ä

### 2. Î≥ÄÌôò ÏãúÏä§ÌÖú Ïã§Ìñâ Î∂àÍ∞Ä

- ES Î™®Îìà Ìò∏ÌôòÏÑ± Î¨∏Ï†ú
- TypeScript Ïª¥ÌååÏùº ÌõÑ Ïã§Ìñâ Ïò§Î•ò

### 3. Îç∞Ïù¥ÌÑ∞ Íµ¨Ï°∞ Î∂àÏùºÏπò

- JSONÏùò Ïî¨ Íµ¨Ï°∞ÏôÄ DBÏùò Ïù¥Î≤§Ìä∏ Íµ¨Ï°∞ Î∂àÏùºÏπò
- ÏãúÎÇòÎ¶¨Ïò§ ID Ï§ëÎ≥µ Î¨∏Ï†ú

## üîß Í∞úÏÑ† Î∞©Ïïà

### 1. Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ Ïä§ÌÇ§Îßà ÏàòÏ†ï (ÌïÑÏàò)

```sql
-- 1. scenario ÌÖåÏù¥Î∏îÏóê difficulty Ïª¨Îüº Ï∂îÍ∞Ä
ALTER TABLE scenario
ADD COLUMN difficulty VARCHAR(20) NOT NULL DEFAULT 'easy'
COMMENT 'ÎÇúÏù¥ÎèÑ (easy, medium, hard, expert)'
AFTER risk_level;

-- 2. scenario_scene ÌÖåÏù¥Î∏î ÏÉùÏÑ±
CREATE TABLE scenario_scene (
    scene_id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT 'Ïî¨ ID',
    scenario_id BIGINT NOT NULL COMMENT 'ÏãúÎÇòÎ¶¨Ïò§ ID',
    scene_code VARCHAR(50) NOT NULL COMMENT 'Ïî¨ ÏΩîÎìú (Ïòà: #1-1, #1-2)',
    scene_order INT NOT NULL COMMENT 'Ïî¨ ÏàúÏÑú',
    title VARCHAR(255) NOT NULL COMMENT 'Ïî¨ Ï†úÎ™©',
    content TEXT NOT NULL COMMENT 'Ïî¨ ÎÇ¥Ïö©',
    scene_script TEXT NOT NULL COMMENT 'Ïî¨ Ïä§ÌÅ¨Î¶ΩÌä∏',
    image_url VARCHAR(500) COMMENT 'Ïî¨ Ïù¥ÎØ∏ÏßÄ URL',
    video_url VARCHAR(500) COMMENT 'Ïî¨ ÎπÑÎîîÏò§ URL',
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'ÏÉùÏÑ±ÏùºÏãú',
    created_by BIGINT NOT NULL COMMENT 'ÏÉùÏÑ±Ïûê ID',
    updated_at DATETIME ON UPDATE CURRENT_TIMESTAMP COMMENT 'ÏàòÏ†ïÏùºÏãú',
    updated_by BIGINT COMMENT 'ÏàòÏ†ïÏûê ID',
    deleted_at DATETIME NULL COMMENT 'ÏÇ≠Ï†úÏùºÏãú',
    is_active TINYINT(1) NOT NULL DEFAULT 1 COMMENT 'ÌôúÏÑ±Ìôî Ïó¨Î∂Ä (1: ÌôúÏÑ±, 0: ÎπÑÌôúÏÑ±)',
    FOREIGN KEY (scenario_id) REFERENCES scenario(scenario_id),
    UNIQUE KEY uk_scenario_scene_code (scenario_id, scene_code)
);

-- 3. choice_option ÌÖåÏù¥Î∏î ÏàòÏ†ï
ALTER TABLE choice_option
ADD COLUMN scene_id BIGINT COMMENT 'Ïî¨ ID'
AFTER scenario_id;

ALTER TABLE choice_option
ADD CONSTRAINT fk_choice_scene
FOREIGN KEY (scene_id) REFERENCES scenario_scene(scene_id);

-- 4. Ìè¨Ïù∏Ìä∏ Ï†ïÎ≥¥ Ïª¨Îüº Ï∂îÍ∞Ä
ALTER TABLE choice_option
ADD COLUMN speed_points INT NOT NULL DEFAULT 0 COMMENT 'ÏÜçÎèÑ Ï†êÏàò'
AFTER is_correct;

ALTER TABLE choice_option
ADD COLUMN accuracy_points INT NOT NULL DEFAULT 0 COMMENT 'Ï†ïÌôïÎèÑ Ï†êÏàò'
AFTER speed_points;

ALTER TABLE choice_option
ADD COLUMN exp_points INT NOT NULL DEFAULT 0 COMMENT 'Í≤ΩÌóòÏπò Ï†êÏàò'
AFTER accuracy_points;

ALTER TABLE choice_option
ADD COLUMN next_scene_code VARCHAR(50) COMMENT 'Îã§Ïùå Ïî¨ ÏΩîÎìú'
AFTER exp_points;
```

### 2. Í∞úÏÑ†Îêú Î≥ÄÌôòÍ∏∞ Íµ¨ÌòÑ

```typescript
// improved-converter.ts
export class ImprovedScenarioConverter {
  /**
   * JSON ÏãúÎÇòÎ¶¨Ïò§Î•º DB ÌòïÏãùÏúºÎ°ú Î≥ÄÌôò
   */
  convertToDatabaseFormat(jsonData: any[]): {
    scenarios: ScenarioData[];
    scenes: SceneData[];
    options: OptionData[];
  } {
    const scenarios: ScenarioData[] = [];
    const scenes: SceneData[] = [];
    const options: OptionData[] = [];

    // ÏãúÎÇòÎ¶¨Ïò§Î≥ÑÎ°ú Í∑∏Î£πÌôî
    const scenarioGroups = this.groupByScenario(jsonData);

    scenarioGroups.forEach((scenes, scenarioCode) => {
      const firstScene = scenes[0];

      // ÏãúÎÇòÎ¶¨Ïò§ Îç∞Ïù¥ÌÑ∞ ÏÉùÏÑ±
      const scenario: ScenarioData = {
        scenario_code: scenarioCode,
        team_id: firstScene.teamId || 1,
        title: this.extractScenarioTitle(firstScene),
        description: this.extractScenarioDescription(firstScene),
        disaster_type: firstScene.disasterType || "fire",
        risk_level: firstScene.riskLevel || "MEDIUM",
        difficulty: firstScene.difficulty || "easy",
        status: "ACTIVE",
        created_by: firstScene.createdBy || 1,
      };
      scenarios.push(scenario);

      // Ïî¨ Îç∞Ïù¥ÌÑ∞ ÏÉùÏÑ±
      scenes.forEach((scene, index) => {
        const sceneData: SceneData = {
          scenario_code: scenarioCode,
          scene_code: scene.sceneId,
          scene_order: scene.order || index + 1,
          title: scene.title,
          content: scene.content,
          scene_script: scene.sceneScript,
          created_by: scene.createdBy || 1,
        };
        scenes.push(sceneData);

        // ÏÑ†ÌÉù ÏòµÏÖò Îç∞Ïù¥ÌÑ∞ ÏÉùÏÑ±
        if (scene.options && Array.isArray(scene.options)) {
          scene.options.forEach((option: any) => {
            const optionData: OptionData = {
              scene_code: scene.sceneId,
              option_code: option.answerId,
              option_text: option.answer,
              reaction_text: option.reaction,
              next_scene_code: option.nextId,
              speed_points: option.points?.speed || 0,
              accuracy_points: option.points?.accuracy || 0,
              exp_points: option.exp || 0,
              is_correct: this.determineCorrectness(option),
              created_by: scene.createdBy || 1,
            };
            options.push(optionData);
          });
        }
      });
    });

    return { scenarios, scenes, options };
  }

  /**
   * ÏãúÎÇòÎ¶¨Ïò§Î≥ÑÎ°ú Ïî¨ Í∑∏Î£πÌôî
   */
  private groupByScenario(data: any[]): Map<string, any[]> {
    const groups = new Map<string, any[]>();

    data.forEach((item) => {
      const scenarioCode = item.scenarioCode || this.generateScenarioCode(item);
      if (!groups.has(scenarioCode)) {
        groups.set(scenarioCode, []);
      }
      groups.get(scenarioCode)!.push(item);
    });

    return groups;
  }

  /**
   * ÏãúÎÇòÎ¶¨Ïò§ ÏΩîÎìú ÏÉùÏÑ±
   */
  private generateScenarioCode(item: any): string {
    const disasterType = item.disasterType || "fire";
    const typeCode = disasterType.toUpperCase().substring(0, 3);
    return `${typeCode}001`;
  }

  /**
   * Ï†ïÎãµ Ïó¨Î∂Ä ÌåêÎã®
   */
  private determineCorrectness(option: any): boolean {
    const points = option.points;
    return points && points.speed > 0 && points.accuracy > 0;
  }
}
```

### 3. SQL ÏÉùÏÑ±Í∏∞ Í∞úÏÑ†

```typescript
// improved-sql-generator.ts
export class ImprovedSQLGenerator {
  /**
   * ÏãúÎÇòÎ¶¨Ïò§ Îç∞Ïù¥ÌÑ∞Î•º SQLÎ°ú Î≥ÄÌôò
   */
  generateSQL(data: {
    scenarios: ScenarioData[];
    scenes: SceneData[];
    options: OptionData[];
  }): string {
    const sqlStatements: string[] = [];

    // 1. ÏãúÎÇòÎ¶¨Ïò§ ÏÉùÏÑ±
    data.scenarios.forEach((scenario) => {
      const scenarioSql = this.generateScenarioSQL(scenario);
      sqlStatements.push(scenarioSql);
    });

    // 2. Ïî¨ ÏÉùÏÑ±
    data.scenes.forEach((scene) => {
      const sceneSql = this.generateSceneSQL(scene);
      sqlStatements.push(sceneSql);
    });

    // 3. ÏÑ†ÌÉù ÏòµÏÖò ÏÉùÏÑ±
    data.options.forEach((option) => {
      const optionSql = this.generateOptionSQL(option);
      sqlStatements.push(optionSql);
    });

    return sqlStatements.join("\n\n");
  }

  private generateScenarioSQL(scenario: ScenarioData): string {
    return `
-- ÏãúÎÇòÎ¶¨Ïò§ ÏÉùÏÑ±: ${scenario.title}
INSERT INTO scenario (team_id, scenario_code, title, description, disaster_type, risk_level, difficulty, status, created_by, created_at) 
VALUES (${scenario.team_id}, '${scenario.scenario_code}', '${this.escapeSQL(
      scenario.title
    )}', '${this.escapeSQL(scenario.description)}', '${
      scenario.disaster_type
    }', '${scenario.risk_level}', '${scenario.difficulty}', '${
      scenario.status
    }', ${scenario.created_by}, NOW());
SET @scenario_id_${scenario.scenario_code} = LAST_INSERT_ID();`;
  }

  private generateSceneSQL(scene: SceneData): string {
    return `
-- Ïî¨ ÏÉùÏÑ±: ${scene.title}
INSERT INTO scenario_scene (scenario_id, scene_code, scene_order, title, content, scene_script, created_by, created_at)
VALUES (@scenario_id_${scene.scenario_code}, '${scene.scene_code}', ${
      scene.scene_order
    }, '${this.escapeSQL(scene.title)}', '${this.escapeSQL(
      scene.content
    )}', '${this.escapeSQL(scene.scene_script)}', ${scene.created_by}, NOW());
SET @scene_id_${scene.scene_code} = LAST_INSERT_ID();`;
  }

  private generateOptionSQL(option: OptionData): string {
    return `
-- ÏÑ†ÌÉù ÏòµÏÖò ÏÉùÏÑ±: ${option.option_text.substring(0, 30)}...
INSERT INTO choice_option (scene_id, option_code, option_text, reaction_text, next_scene_code, speed_points, accuracy_points, exp_points, is_correct, created_by, created_at)
VALUES (@scene_id_${option.scene_code}, '${
      option.option_code
    }', '${this.escapeSQL(option.option_text)}', '${this.escapeSQL(
      option.reaction_text
    )}', '${option.next_scene_code || "NULL"}', ${option.speed_points}, ${
      option.accuracy_points
    }, ${option.exp_points}, ${option.is_correct ? 1 : 0}, ${
      option.created_by
    }, NOW());`;
  }

  private escapeSQL(str: string): string {
    return str.replace(/'/g, "''");
  }
}
```

### 4. Ïã§Ìñâ Í∞ÄÎä•Ìïú Î≥ÄÌôò Ïä§ÌÅ¨Î¶ΩÌä∏

```typescript
// convert-scenarios.ts
import * as fs from "fs";
import * as path from "path";
import { ImprovedScenarioConverter } from "./improved-converter";
import { ImprovedSQLGenerator } from "./improved-sql-generator";

async function convertScenarios() {
  const converter = new ImprovedScenarioConverter();
  const sqlGenerator = new ImprovedSQLGenerator();

  // JSON ÌååÏùºÎì§ Î≥ÄÌôò
  const jsonFiles = [
    "../data/fire_training_scenario.json",
    "../data/emergency_first_aid_scenario.json",
    "../data/traffic_accident_scenario.json",
    "../data/earthquake_training_scenario.json",
  ];

  const allScenarios: any[] = [];
  const allScenes: any[] = [];
  const allOptions: any[] = [];

  for (const file of jsonFiles) {
    console.log(`Î≥ÄÌôò Ï§ë: ${file}`);

    const jsonData = JSON.parse(fs.readFileSync(file, "utf8"));
    const converted = converter.convertToDatabaseFormat(jsonData);

    allScenarios.push(...converted.scenarios);
    allScenes.push(...converted.scenes);
    allOptions.push(...converted.options);
  }

  // SQL ÏÉùÏÑ±
  const sql = sqlGenerator.generateSQL({
    scenarios: allScenarios,
    scenes: allScenes,
    options: allOptions,
  });

  // SQL ÌååÏùº Ï†ÄÏû•
  const outputFile = `./output/scenarios_${Date.now()}.sql`;
  fs.writeFileSync(outputFile, sql, "utf8");

  console.log(`Î≥ÄÌôò ÏôÑÎ£å: ${outputFile}`);
  console.log(`ÏãúÎÇòÎ¶¨Ïò§: ${allScenarios.length}Í∞ú`);
  console.log(`Ïî¨: ${allScenes.length}Í∞ú`);
  console.log(`ÏòµÏÖò: ${allOptions.length}Í∞ú`);
}

convertScenarios().catch(console.error);
```

## üéØ Í∞úÏÑ†Îêú Î≥ÄÌôò ÏãúÏä§ÌÖúÏùò Ïû•Ï†ê

### 1. **Îç∞Ïù¥ÌÑ∞ ÏùºÍ¥ÄÏÑ± Î≥¥Ïû•**

- JSONÍ≥º DB Ïä§ÌÇ§Îßà Í∞Ñ ÏôÑÎ≤ΩÌïú Îß§Ìïë
- Ïî¨Î≥Ñ Îç∞Ïù¥ÌÑ∞ Íµ¨Ï°∞Ìôî
- ÏãúÎÇòÎ¶¨Ïò§ ÏΩîÎìúÎ°ú Î™ÖÌôïÌïú Íµ¨Î∂Ñ

### 2. **Ïã§Ìñâ Í∞ÄÎä•ÏÑ±**

- ES Î™®Îìà Ìò∏ÌôòÏÑ± Î¨∏Ï†ú Ìï¥Í≤∞
- TypeScript Ïª¥ÌååÏùº Ïò§Î•ò ÏàòÏ†ï
- Ïã§Ï†ú Ïã§Ìñâ Í∞ÄÎä•Ìïú Î≥ÄÌôò Ïä§ÌÅ¨Î¶ΩÌä∏

### 3. **ÌôïÏû•ÏÑ±**

- ÏÉàÎ°úÏö¥ ÏãúÎÇòÎ¶¨Ïò§ Ïú†Ìòï Ï∂îÍ∞Ä Ïö©Ïù¥
- Ïî¨Î≥Ñ ÏÑ∏Î∂Ä Í¥ÄÎ¶¨ Í∞ÄÎä•
- ÌÜµÍ≥Ñ Î∞è Î∂ÑÏÑù Îç∞Ïù¥ÌÑ∞ ÌíçÎ∂ÄÌôî

### 4. **Ïú†ÏßÄÎ≥¥ÏàòÏÑ±**

- Î™ÖÌôïÌïú Îç∞Ïù¥ÌÑ∞ Íµ¨Ï°∞
- ÏùºÍ¥ÄÎêú ÎÑ§Ïù¥Î∞ç Ïª®Î≤§ÏÖò
- ÌÉÄÏûÖ ÏïàÏ†ÑÏÑ± Î≥¥Ïû•

## üöÄ Ïã§Ìñâ Í≥ÑÌöç

1. **DB Ïä§ÌÇ§Îßà ÏàòÏ†ï** (ÌïÑÏàò)
2. **Í∞úÏÑ†Îêú Î≥ÄÌôòÍ∏∞ Íµ¨ÌòÑ**
3. **Î≥ÄÌôò ÌÖåÏä§Ìä∏**
4. **Frontend ÏàòÏ†ï** (ÏÉàÎ°úÏö¥ Îç∞Ïù¥ÌÑ∞ Íµ¨Ï°∞Ïóê ÎßûÍ≤å)

---

**ÏûëÏÑ±Ïùº**: 2024ÎÖÑ 12Ïõî 19Ïùº  
**ÏûëÏÑ±Ïûê**: AI Assistant  
**ÏÉÅÌÉú**: Ï†úÏïà Îã®Í≥Ñ
